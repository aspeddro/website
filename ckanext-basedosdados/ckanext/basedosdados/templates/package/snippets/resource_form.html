{% ckan_extends %}


{% block metadata_fields %}


<hr></hr>
{# https://docs.ckan.org/en/2.9/contributing/frontend/templating.html#form-select #}
{% set resource_types = h.get_possible_resource_types() %}
{{ form.select(name="resource_type", id="field-resource_type", label="resource_type", options=resource_types,
        is_required="true", selected=data.get("resource_type", "external_link")) }}
<hr></hr>
<div id="metadata-jsonform-container"></div>
<div id="res" class="alert"></div>


<script type="module">
  "use strict"
  //TODO: do something similar on package_form
  import 'https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js'
  import "https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.13.1/underscore-min.js"
  import "https://cdnjs.cloudflare.com/ajax/libs/jsonform/2.2.3/jsonform.js"

  var resource = {{ data | tojson | safe }}
  var schemas = {{ h.load_json_schema() | safe }}

  var package_schema = schemas['package']

  function update_form_based_on_resource_type() {
    var resource_type = $("#field-resource_type").val()
    var schema = schemas[resource_type]
    if (!schema) throw `Unsupported resource type '${resource_type}'`
    var opts = {schema: schema
        ,form: [
            "*",
            {
                "type": "actions",
                "items": [ ] // suppress buttons
            }
        ]
        ,value: resource
    }
    $('#metadata-jsonform-container').html('')
    $('#metadata-jsonform-container').jsonForm(opts)
  }
  $('#field-resource_type').on('change', update_form_based_on_resource_type);
  update_form_based_on_resource_type()
</script>
{% endblock %}
